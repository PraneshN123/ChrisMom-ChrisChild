<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ChrisMom">
    
    <meta name="theme-color" content="#1B4332">

    <title>üéÑ ChrisMom & ChrisChild | Winter Magic Edition</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --christmas-red: #D62828;
            --christmas-green: #2D6A4F;
            --dark-green: #1B4332;
            --christmas-gold: #F4D35E;
            --snow-white: #FFFFFF;
            --midnight-blue: #081c15;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --text-main: #1d3557;
            --text-light: #f1faee;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Nunito', sans-serif;
            background: radial-gradient(circle at 50% 0%, #2D6A4F, #081c15);
            color: var(--text-main);
            min-height: 100vh;
            min-height: 100dvh; 
            overflow-x: hidden;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        /* --- VISUALS --- */
        .lights-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px; opacity: 0.3; pointer-events: none; z-index: 0;
        }

        /* GPU Accelerated Snow */
        .snowflake {
            position: fixed; top: -5vh; color: #fff;
            animation: fall linear forwards; 
            z-index: 1; pointer-events: none;
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
            will-change: transform;
        }
        @keyframes fall { to { transform: translateY(105vh) rotate(720deg); } }

        .app-container {
            max-width: 1000px; margin: 0 auto; 
            padding: 2rem 1rem;
            padding-top: max(2rem, env(safe-area-inset-top));
            padding-bottom: max(2rem, env(safe-area-inset-bottom));
            position: relative; z-index: 10;
        }

        h1, h2, h3 { font-family: 'Mountains of Christmas', cursive; font-weight: 700; line-height: 1.2; }
        header h1 { color: var(--christmas-gold); font-size: 3.5rem; text-shadow: 0 4px 15px rgba(0,0,0,0.5); margin-bottom: 0.2rem; }
        header p { color: var(--text-light); opacity: 0.9; }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 2px solid var(--glass-border); border-radius: 24px;
            padding: 2.5rem; box-shadow: var(--glass-shadow);
            margin-bottom: 2rem;
            animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            position: relative; overflow: hidden;
            will-change: transform, opacity;
        }
        .card::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 8px;
            background: repeating-linear-gradient(45deg, var(--christmas-red), var(--christmas-red) 20px, var(--snow-white) 20px, var(--snow-white) 40px, var(--christmas-green) 40px, var(--christmas-green) 60px);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 700; color: var(--christmas-green); font-size: 0.95rem; }
        
        input, select, textarea {
            width: 100%; padding: 14px 18px; border: 2px solid #e1e1e1; border-radius: 14px;
            font-family: 'Nunito', sans-serif; font-size: 16px; 
            transition: all 0.3s ease; background: rgba(255,255,255,0.6);
            appearance: none; -webkit-appearance: none;
        }
        input:focus, textarea:focus { border-color: var(--christmas-red); background: #fff; outline: none; box-shadow: 0 0 0 4px rgba(214, 40, 40, 0.15); transform: translateY(-2px); }

        .btn {
            background: linear-gradient(135deg, var(--christmas-red), #9b2226); color: white; border: none;
            padding: 15px 30px; border-radius: 50px; cursor: pointer; font-weight: 800; font-size: 1.1rem;
            width: 100%; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 15px rgba(214, 40, 40, 0.4); text-transform: uppercase; letter-spacing: 1px;
            position: relative; overflow: hidden;
            touch-action: manipulation;
            user-select: none;
        }
        .btn:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 8px 25px rgba(214, 40, 40, 0.5); }
        .btn:active { transform: translateY(0) scale(0.98); }
        .btn-secondary { background: linear-gradient(135deg, var(--christmas-green), #1b4332); box-shadow: 0 4px 15px rgba(45, 106, 79, 0.4); }
        .btn-gold { background: linear-gradient(135deg, var(--christmas-gold), #e09f3e); color: #4a3b00; box-shadow: 0 4px 15px rgba(244, 211, 94, 0.4); }
        .btn-logout { background: #343a40; font-size: 0.9rem; padding: 8px 20px; box-shadow: none; width: auto; border-radius: 12px; }
        
        .btn-sm { padding: 8px 12px; font-size: 1rem; width: auto; border-radius: 8px; box-shadow: none; background: #e9ecef; color: #333; cursor: pointer; border: 1px solid #ccc; display: inline-flex; align-items: center; justify-content: center; margin-left: 5px; touch-action: manipulation;}
        
        .btn-danger { background: #ff6b6b; color: white; border: 1px solid #fa5252; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; display: inline-flex; align-items: center; gap: 5px; }
        .status-pending { background: #ffe5e5; color: #c92a2a; border: 1px solid #ffc9c9; }
        .status-completed { background: #fff3bf; color: #a67f0d; border: 1px solid #ffec99; }
        .status-approved { background: #d3f9d8; color: #2b8a3e; border: 1px solid #b2f2bb; }

        /* Wheel optimized for responsiveness & IOS */
        .wheel-wrapper { 
            position: relative; width: 300px; height: 300px; max-width: 85vw; max-height: 85vw;
            margin: 0 auto; padding: 0;
            border-radius: 50%; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            border: 5px solid rgba(255,255,255,0.8);
            background: transparent;
        }
        #wheelCanvas { width: 100%; height: 100%; border-radius: 50%; display: block; }
        
        .wheel-pointer { 
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%); 
            z-index: 10; 
            width: 0; height: 0; 
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #333; 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
            pointer-events: none; 
        }

        /* Chat optimized for Mobile Keyboards */
        .chat-container { 
            border: 1px solid rgba(255,255,255,0.5); border-radius: 20px; 
            background: rgba(255, 255, 255, 0.5); padding: 15px; 
            height: 380px; display: flex; flex-direction: column; 
        }
        .chat-box { 
            flex-grow: 1; overflow-y: auto; padding: 10px; margin-bottom: 15px; 
            display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; 
            -webkit-overflow-scrolling: touch;
        }
        /* Message Styling & Link Handling */
        .message { 
            max-width: 85%; padding: 12px 16px; border-radius: 18px; 
            font-size: 0.95rem; line-height: 1.4; position: relative; 
            animation: popIn 0.3s ease; 
            /* Fix for exceeding chat */
            word-wrap: break-word; 
            word-break: break-word; 
            white-space: pre-wrap;
        }
        .message a { color: inherit; text-decoration: underline; font-weight: bold; }
        
        @keyframes popIn { from{transform: scale(0.8); opacity:0;} to{transform: scale(1); opacity:1;} }
        
        .msg-sent { align-self: flex-end; background: var(--christmas-green); color: white; border-bottom-right-radius: 4px; }
        .msg-received { align-self: flex-start; background: white; color: var(--text-main); border-bottom-left-radius: 4px; }
        .msg-meta { font-size: 0.65rem; opacity: 0.7; margin-top: 4px; text-align: right; font-weight: 700; }
        
        /* Chat Action Buttons */
        .msg-actions { display: inline-flex; gap: 5px; margin-left: 8px; vertical-align: middle; }
        .msg-btn { 
            cursor: pointer; opacity: 0.6; font-size: 0.8rem; color: #fff; 
            padding: 2px 4px; border-radius: 4px; transition: opacity 0.2s; 
        }
        .msg-btn:hover { opacity: 1; background: rgba(255,255,255,0.2); }

        /* Mobile Responsive Task Item */
        .task-item {
            border-bottom: 1px solid #f0f0f0; padding: 12px 0;
            display: flex; align-items: center; justify-content: space-between;
            gap: 10px;
        }
        .task-content { flex: 1; min-width: 0; }
        .task-text { font-weight: 700; color: #333; margin-bottom: 4px; word-break: break-word; }
        .task-actions { flex-shrink: 0; display: flex; gap: 5px; align-items: center; }
        .task-action-btn { font-size: 0.75rem; padding: 6px 12px; width: auto; border-radius: 12px; white-space: nowrap; }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .flex-row { display: flex; align-items: center; justify-content: space-between; gap: 15px; }
        .mt-4 { margin-top: 1.5rem; }
        
        #toast { visibility: hidden; min-width: 300px; width: 90%; max-width: 400px; background: rgba(11, 79, 40, 0.95); color: #fff; text-align: center; border-radius: 50px; padding: 16px 24px; position: fixed; z-index: 2000; left: 50%; bottom: 40px; bottom: max(40px, env(safe-area-inset-bottom)); transform: translateX(-50%); box-shadow: 0 10px 30px rgba(0,0,0,0.4); font-weight: 700; border: 2px solid var(--christmas-gold); will-change: opacity, bottom; }
        #toast.show { visibility: visible; animation: fadeUp 0.5s, fadeOut 0.5s 2.5s forwards; }
        @keyframes fadeUp { from {bottom: 0; opacity: 0;} to {bottom: max(40px, env(safe-area-inset-bottom)); opacity: 1;} }
        @keyframes fadeOut { from {bottom: max(40px, env(safe-area-inset-bottom)); opacity: 1;} to {bottom: 0; opacity: 0;} }

        @media (max-width: 768px) { 
            .grid-2 { grid-template-columns: 1fr; } 
            header h1 { font-size: 2.5rem; } 
            .card { padding: 1.5rem; }
            .app-container { padding-left: 15px; padding-right: 15px; }
            .btn { padding: 12px 20px; }
        }
    </style>
</head>
<body>

    <div class="lights-overlay"></div>
    <div id="snow-container"></div>
    <canvas id="confetti-canvas"></canvas>

    <div class="app-container">
        <header class="text-center">
            <h1><i class="fas fa-sleigh" style="margin-right: 10px;"></i>ChrisMom & ChrisChild</h1>
            <p>The Ultimate Winter Wonderland Secret Santa</p>
        </header>

        <div id="login-screen" class="card mt-4" style="max-width: 450px; margin-left: auto; margin-right: auto;">
            <div class="text-center mb-4">
                <i class="fas fa-cookie-bite fa-3x" style="color: var(--christmas-gold); margin-bottom: 15px;"></i>
                <h2 style="color: var(--christmas-red);">Welcome Back!</h2>
                <p style="color: #666;">Enter your festive credentials</p>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-user"></i> Username</label>
                <input type="text" id="login-username" placeholder="e.g. NorthPoleAdmin" autocomplete="username">
            </div>
            <div class="form-group">
                <label><i class="fas fa-key"></i> Password</label>
                <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            </div>
            <button class="btn" id="btn-login">Open the Door üö™</button>
            <p class="text-center mt-4">New Elf? <a href="#" id="link-register" style="color: var(--christmas-green); font-weight: bold; text-decoration: none;">Join the List üìú</a></p>
        </div>

        <div id="register-screen" class="card mt-4 hidden" style="max-width: 450px; margin-left: auto; margin-right: auto;">
            <div class="text-center mb-4">
                <i class="fas fa-snowman fa-3x" style="color: var(--christmas-green); margin-bottom: 15px;"></i>
                <h2 style="color: var(--christmas-green);">Join the Fun</h2>
            </div>
            <div id="reg-closed-msg" class="hidden text-center" style="background: #ffe5e5; padding: 20px; border-radius: 16px; color: #c92a2a; border: 2px dashed #c92a2a;">
                <i class="fas fa-lock fa-2x mb-2"></i><br><b>Registration Closed</b><br>The sleigh has already departed!
            </div>
            <div id="reg-form-content">
                <div class="form-group"><label>Choose a Unique Name</label><input type="text" id="reg-username" placeholder="e.g. Rudolph23" autocomplete="off"></div>
                <div class="form-group"><label>Secret Password</label><input type="password" id="reg-password" placeholder="Make it memorable" autocomplete="new-password"></div>
                <button class="btn btn-secondary" id="btn-register">Sign Me Up üìù</button>
            </div>
            <p class="text-center mt-4"><a href="#" id="link-login" style="color: var(--christmas-red); font-weight: bold; text-decoration: none;">Back to Login</a></p>
        </div>

        <div id="admin-screen" class="card hidden">
            <div class="flex-row" style="margin-bottom: 25px; border-bottom: 2px solid rgba(0,0,0,0.05); padding-bottom: 15px;">
                <div><h2 style="color: var(--text-main); margin:0;">üëë Santa's Control Room</h2><small>Manage the chaos</small></div>
                <div>
                    <button class="btn btn-sm" id="btn-admin-change-pass" style="background: var(--christmas-red); color: white; border: none; margin-right: 10px;"><i class="fas fa-key"></i> Pass</button>
                    <button class="btn btn-logout" id="admin-logout"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
            <div class="grid-2">
                <div style="background: rgba(255,255,255,0.7); padding: 25px; border-radius: 20px; border: 1px solid white;">
                    <h3 style="color: var(--christmas-red); margin-bottom: 20px;"><i class="fas fa-cogs"></i> Game Settings</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                        <span><i class="fas fa-clipboard-list"></i> Reg: <span id="reg-status-display" style="font-weight:800;">OPEN</span></span>
                        <button id="btn-toggle-reg" class="btn btn-secondary" style="width: auto; padding: 8px 15px; font-size: 0.8rem;">Toggle</button>
                    </div>
                    <button id="btn-reveal-all" class="btn btn-gold mt-4"><i class="fas fa-gift"></i> REVEAL ALL IDENTITIES</button>
                    <button id="btn-reset-game" class="btn" style="background: #212529; margin-top: 15px; font-size: 0.9rem;"><i class="fas fa-trash-alt"></i> RESET ALL DATA</button>
                </div>
                <div class="text-center">
                    <h3 style="color: var(--christmas-green); margin-bottom: 15px;">The Sorting Wheel</h3>
                    <div class="wheel-wrapper">
                        <div class="wheel-pointer"></div>
                        <canvas id="wheelCanvas"></canvas>
                    </div>
                    <button id="btn-spin" class="btn btn-gold mt-4" style="max-width: 250px;">üé° SPIN TO PAIR</button>
                    <p id="spin-result" style="margin-top: 15px; font-weight: 800; color: var(--christmas-green); font-size: 1.1rem;"></p>
                    <p style="font-size: 0.75rem; color: #D62828;">*Spinning will reset existing tasks!</p>
                </div>
            </div>
            <div class="grid-2 mt-4">
                <div>
                    <h3><i class="fas fa-users"></i> Elves <span id="elves-count" style="font-size:0.7em; background:var(--christmas-red); color:white; padding:2px 8px; border-radius:12px; vertical-align:middle; margin-left:8px;">0</span></h3>
                    <div style="background: white; border-radius: 16px; height: 250px; overflow-y: auto; padding: 10px; border: 1px solid #eee;">
                        <table style="width:100%; border-collapse: collapse;">
                            <thead style="background: #f8f9fa; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding:10px; text-align:left; color:#666;">Name</th>
                                    <th style="padding:10px; text-align:center; color:#666;">Pwd</th>
                                    <th style="padding:10px; text-align:right; color:#666;">Act</th>
                                </tr>
                            </thead>
                            <tbody id="admin-users-table"></tbody>
                        </table>
                    </div>
                </div>
                <div><h3><i class="fas fa-link"></i> Connections</h3><div style="background: white; border-radius: 16px; height: 250px; overflow-y: auto; padding: 10px; border: 1px solid #eee;"><table style="width:100%; border-collapse: collapse;"><thead style="background: #f8f9fa; position: sticky; top: 0;"><tr><th style="padding:10px; text-align:left; color:#666;">Mom</th><th style="padding:10px; text-align:center;"></th><th style="padding:10px; text-align:left; color:#666;">Child</th></tr></thead><tbody id="admin-pairings-table"></tbody></table></div></div>
            </div>
        </div>

        <div id="user-screen" class="hidden">
            <div class="flex-row" style="margin-bottom: 2rem;">
                <div style="color: var(--text-light); text-shadow: 0 2px 4px rgba(0,0,0,0.8);">
                    <h2 style="margin:0; font-size: 2.2rem;">Hello, <span id="display-username" style="color: var(--christmas-gold);">User</span>! üéÖ</h2>
                    <small style="font-size: 1rem; opacity: 0.9;">Your Secret Mission awaits...</small>
                </div>
                <button class="btn btn-logout" id="user-logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>

            <div class="grid-2">
                <div class="card">
                    <h3 style="color: var(--christmas-red);"><i class="fas fa-gift"></i> You are ChrisMom to:</h3>
                    <div id="mom-waiting-msg" class="text-center" style="padding: 40px 0; color: #666;"><i class="fas fa-snowflake fa-spin fa-3x" style="color: #ccc; margin-bottom: 20px;"></i><p>Waiting for Santa (Admin) to spin the wheel!</p></div>
                    <div id="mom-panel-content" class="hidden">
                        <div class="text-center" style="background: linear-gradient(135deg, #fff5f5, #fff); padding: 25px; border-radius: 20px; border: 2px dashed var(--christmas-red); margin: 20px 0; box-shadow: 0 4px 15px rgba(214, 40, 40, 0.1);">
                            <h2 id="my-child-name" style="color:var(--christmas-red); font-size: 2.5rem; margin:0; letter-spacing: 1px;">???</h2><small style="color: #999; font-weight: 700;">SHH! IT'S A SECRET!</small>
                        </div>
                        <h4 style="color: var(--text-main); margin-top: 25px;"><i class="fas fa-tasks"></i> Assign a Task</h4>
                        <div class="form-group" style="margin-top: 10px;">
                            <textarea id="task-input" rows="2" placeholder="e.g. Draw a snowman, Sing Jingle Bells..."></textarea>
                            <button id="btn-send-task" class="btn btn-secondary mt-4"><i class="fas fa-paper-plane"></i> Send Challenge</button>
                        </div>
                        <h4 class="mt-4"><i class="fas fa-clipboard-check"></i> Review Child's Tasks</h4>
                        <div id="mom-review-list" style="height:200px; overflow-y:auto; background:white; padding:15px; border-radius:16px; border: 1px solid #e1e1e1;"></div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="color: var(--christmas-green);"><i class="fas fa-baby"></i> Your ChrisMom says:</h3>
                    <div id="child-panel-content" class="hidden">
                        <div class="text-center" style="margin-bottom: 20px;"><span style="font-size: 0.9rem; color: #666;">Your Secret Santa is:</span><h2 id="my-mom-name" style="color:var(--christmas-green); font-size: 2rem;">SECRET ü§´</h2></div>
                        <div id="active-task-container" style="background: linear-gradient(135deg, #fffbeb, #fff); padding: 25px; border-radius: 20px; border: 2px solid var(--christmas-gold); box-shadow: 0 8px 20px rgba(244, 211, 94, 0.15);">
                            <h4 style="color: #b45309; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;"><i class="fas fa-star"></i> Today's Challenge</h4>
                            <p id="current-task-text" style="font-size: 1.4rem; font-weight: 800; margin: 15px 0; color: #333; line-height: 1.3;">No active tasks yet.</p>
                            <div id="task-action-area" class="hidden"><button id="btn-complete-task" class="btn btn-gold">Mark as Done ‚úÖ</button></div>
                            <p id="task-status-msg" class="text-center" style="font-style:italic; font-size:0.9rem; margin-top: 15px; color: #666;"></p>
                        </div>
                        <h4 class="mt-4"><i class="fas fa-history"></i> Task History</h4>
                        <ul id="child-task-history" style="font-size:0.9rem; padding-left:20px; line-height: 1.8; color: #555;"></ul>
                    </div>
                </div>
            </div>

            <div class="card mt-4 hidden" id="chat-section">
                <div class="text-center mb-4"><h3><i class="fas fa-comments"></i> North Pole Line</h3><p style="opacity: 0.7;">Chat anonymously. Encrypted by magic!</p></div>
                <div class="grid-2">
                    <div>
                        <h4 class="text-center" style="color: var(--christmas-red); margin-bottom: 10px;">To Your Child üë∂</h4>
                        <div class="chat-container">
                            <div class="chat-box" id="chat-box-child"></div>
                            <div class="flex-row" style="gap: 10px;">
                                <input type="text" id="msg-input-child" placeholder="Type..." style="padding: 12px;">
                                <button class="btn btn-secondary" style="width:auto; padding: 12px 18px; border-radius: 14px;" id="btn-send-child"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-center" style="color: var(--christmas-green); margin-bottom: 10px;">To Your ChrisMom üéÖ</h4>
                        <div class="chat-container">
                            <div class="chat-box" id="chat-box-mom"></div>
                            <div class="flex-row" style="gap: 10px;">
                                <input type="text" id="msg-input-mom" placeholder="Type..." style="padding: 12px;">
                                <button class="btn btn-secondary" style="width:auto; padding: 12px 18px; border-radius: 14px;" id="btn-send-mom"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer style="text-align: center; margin-top: 3rem; color: rgba(255,255,255,0.7); font-size: 0.9rem; padding-bottom: 10px;"><p>Made with <i class="fas fa-heart" style="color: var(--christmas-red);"></i> by Event Team</p></footer>
    </div>

    <div id="toast">Notification</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, where, addDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyD9H6lcZ2rVjzX-_x93xpFn1efK9khEgPw",
            authDomain: "chrismom-a52a8.firebaseapp.com",
            projectId: "chrismom-a52a8",
            storageBucket: "chrismom-a52a8.firebasestorage.app",
            messagingSenderId: "227031044852",
            appId: "1:227031044852:web:0e6db2c8037b4abfc4c4a1",
            measurementId: "G-BV9WXB69GN"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); 
        const db = getFirestore(app);

        // --- STATE ---
        let currentUser = null;
        let myChild = null;
        let myMom = null;
        let gameConfig = { registrationOpen: true, revealed: false };
        let loginTime = 0;
        
        // Unsub functions
        let unsubConfig, unsubUsers, unsubPairings, unsubTasksMom, unsubTasksChild, unsubChatChild, unsubChatMom;

        // --- DOM HELPER ---
        const getEl = (id) => document.getElementById(id);
        const screens = {
            login: getEl('login-screen'),
            register: getEl('register-screen'),
            admin: getEl('admin-screen'),
            user: getEl('user-screen')
        };

        // --- SOUND LOGIC ---
        const notifSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2996/2996-preview.mp3");
        notifSound.volume = 0.5;
        let audioUnlocked = false;

        function playNotification() {
            if (audioUnlocked) {
                notifSound.currentTime = 0;
                notifSound.play().catch(e => console.log("Sound play failed:", e));
            }
        }

        // --- SYSTEM NOTIFICATION HELPER ---
        function sendSystemNotification(title, body) {
            if (!("Notification" in window)) return;
            if (Notification.permission === "granted") {
                if("vibrate" in navigator) navigator.vibrate([200, 100, 200]);
                new Notification(title, { 
                    body: body, 
                    icon: 'https://img.icons8.com/color/48/christmas-star.png'
                });
            }
        }

        // --- VISUAL EFFECTS ---
        function createSnow() {
            const container = getEl('snow-container');
            container.innerHTML = '';
            const isMobile = window.innerWidth < 768;
            const count = isMobile ? 25 : 50; 
            
            for(let i=0; i<count; i++) {
                const snow = document.createElement('div');
                snow.className = 'snowflake';
                snow.innerHTML = ['‚ùÑ', '‚ùÖ', '‚ùÜ'][Math.floor(Math.random()*3)];
                snow.style.left = Math.random() * 100 + 'vw';
                snow.style.animationDuration = Math.random() * 5 + 5 + 's';
                snow.style.opacity = Math.random() * 0.6 + 0.2;
                snow.style.fontSize = Math.random() * 15 + 10 + 'px';
                snow.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(snow);
            }
        }
        createSnow();

        // --- OPTIMIZED CONFETTI ---
        const canvas = getEl('confetti-canvas');
        let confettiParticles = [];
        let animationId = null;
        
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => { resizeCanvas(); createSnow(); }, 100);
        });

        function resizeCanvas() { 
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight; 
        }
        resizeCanvas();

        function fireConfetti() {
            resizeCanvas();
            confettiParticles = [];
            const count = window.innerWidth < 768 ? 60 : 120;
            for (let i = 0; i < count; i++) {
                confettiParticles.push({
                    x: canvas.width / 2, y: canvas.height / 2, w: Math.random() * 10 + 5, h: Math.random() * 10 + 5,
                    color: ['#D62828', '#2D6A4F', '#F4D35E', '#FFFFFF'][Math.floor(Math.random() * 4)],
                    vx: (Math.random() - 0.5) * 20, vy: (Math.random() - 0.5) * 20, gravity: 0.5, drag: 0.96
                });
            }
            if (!animationId) animateConfetti();
        }

        function animateConfetti() {
            const ctx = canvas.getContext('2d');
            if (confettiParticles.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                animationId = null;
                return;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            confettiParticles.forEach((p, index) => {
                p.x += p.vx; p.y += p.vy; p.vy += p.gravity; p.vx *= p.drag; p.vy *= p.drag;
                ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.w, p.h);
                if (p.y > canvas.height) confettiParticles.splice(index, 1);
            });
            animationId = requestAnimationFrame(animateConfetti);
        }

        // --- AUTH & STATE MANAGEMENT ---
        const sessionUser = sessionStorage.getItem('currentUser');
        if (sessionUser) handleLoginSuccess(JSON.parse(sessionUser));

        if(unsubConfig) unsubConfig();
        unsubConfig = onSnapshot(doc(db, "config", "settings"), (docSnap) => {
            if (docSnap.exists()) {
                gameConfig = docSnap.data();
                updateUIBasedOnConfig();
            } else {
                setDoc(doc(db, "config", "settings"), { registrationOpen: true, revealed: false });
            }
        });

        function updateUIBasedOnConfig() {
            const isOpen = gameConfig.registrationOpen;
            const regDisplay = getEl('reg-status-display');
            if(regDisplay) {
                regDisplay.innerText = isOpen ? "OPEN" : "CLOSED";
                regDisplay.style.color = isOpen ? "var(--christmas-green)" : "var(--christmas-red)";
            }
            
            const regFormContent = getEl('reg-form-content');
            const regClosedMsg = getEl('reg-closed-msg');
            const btnToggle = getEl('btn-toggle-reg');

            if(isOpen) {
                if(regFormContent) regFormContent.classList.remove('hidden');
                if(regClosedMsg) regClosedMsg.classList.add('hidden');
                if(btnToggle) btnToggle.innerText = "Close";
            } else {
                if(regFormContent) regFormContent.classList.add('hidden');
                if(regClosedMsg) regClosedMsg.classList.remove('hidden');
                if(btnToggle) btnToggle.innerText = "Open";
            }

            if (currentUser && currentUser.username !== 'ADMIN') {
                if (gameConfig.revealed) {
                    if (myChild) getEl('my-child-name').innerText = myChild;
                    if (myMom) getEl('my-mom-name').innerText = myMom;
                } else {
                    if (myChild) getEl('my-child-name').innerText = myChild;
                    getEl('my-mom-name').innerText = "SECRET ü§´";
                }
            }
        }

        getEl('btn-login').addEventListener('click', async () => {
            if (!audioUnlocked) {
                notifSound.play().then(() => {
                    notifSound.pause();
                    notifSound.currentTime = 0;
                    audioUnlocked = true;
                }).catch((e) => console.log("Audio unlock failed:", e));
            }
            if (Notification.permission !== "granted") {
                Notification.requestPermission();
            }

            const u = getEl('login-username').value.trim();
            const p = getEl('login-password').value.trim();
            if(!u || !p) return showToast("Please fill all fields üéÖ");

            if(u === 'ADMIN') {
                try {
                    const adminRef = doc(db, "users", "ADMIN");
                    const adminSnap = await getDoc(adminRef);
                    if (!adminSnap.exists()) {
                        if (p === 'admin') {
                            const adminData = { username: 'ADMIN', password: 'admin', role: 'admin' };
                            await setDoc(adminRef, adminData);
                            sessionStorage.setItem('currentUser', JSON.stringify(adminData));
                            handleLoginSuccess(adminData);
                            showToast("Admin init! Change password.");
                        } else { showToast("Invalid Admin Credentials"); }
                    } else {
                        const adminData = adminSnap.data();
                        if (adminData.password === p) {
                            sessionStorage.setItem('currentUser', JSON.stringify(adminData));
                            handleLoginSuccess(adminData);
                        } else { showToast("Invalid Admin Password"); }
                    }
                } catch(e) { console.error(e); showToast("Login Error"); }
                return;
            }

            try {
                const userDoc = await getDoc(doc(db, "users", u));
                if(userDoc.exists() && userDoc.data().password === p) {
                    sessionStorage.setItem('currentUser', JSON.stringify(userDoc.data()));
                    handleLoginSuccess(userDoc.data());
                } else { showToast("Naughty List! Check credentials. üìú"); }
            } catch(e) { console.error(e); showToast("Login Error"); }
        });

        getEl('link-register').onclick = (e) => { e.preventDefault(); toggleScreen('register'); };
        getEl('link-login').onclick = (e) => { e.preventDefault(); toggleScreen('login'); };

        getEl('btn-register').addEventListener('click', async () => {
            if(!gameConfig.registrationOpen) return showToast("Registration is currently closed!");
            const u = getEl('reg-username').value.trim();
            const p = getEl('reg-password').value.trim();
            if(!u || !p) return showToast("Please fill all fields üéÅ");
            if(u.toUpperCase() === 'ADMIN') return showToast("Nice try, Elf!");

            try {
                const check = await getDoc(doc(db, "users", u));
                if(check.exists()) return showToast("Username already taken! üòî");
                await setDoc(doc(db, "users", u), { username: u, password: p, role: 'user', joinedAt: serverTimestamp() });
                showToast("Welcome! Please Login.");
                toggleScreen('login');
            } catch(e) { console.error(e); showToast("Reg Error"); }
        });

        getEl('admin-logout').onclick = logout;
        getEl('user-logout').onclick = logout;

        function logout() { 
            if(unsubUsers) unsubUsers();
            if(unsubPairings) unsubPairings();
            if(unsubTasksMom) unsubTasksMom();
            if(unsubTasksChild) unsubTasksChild();
            if(unsubChatChild) unsubChatChild();
            if(unsubChatMom) unsubChatMom();
            
            sessionStorage.clear(); 
            location.reload(); 
        }

        function handleLoginSuccess(user) {
            currentUser = user;
            loginTime = Date.now(); 
            getEl('login-username').value = ""; getEl('login-password').value = "";
            if(user.role === 'admin') { toggleScreen('admin'); initAdminPanel(); } 
            else { toggleScreen('user'); initUserPanel(user.username); }
        }

        function toggleScreen(name) { 
            window.scrollTo(0,0);
            Object.values(screens).forEach(el => el.classList.add('hidden')); 
            screens[name].classList.remove('hidden'); 
        }
        function showToast(msg) {
            const t = getEl('toast'); t.innerHTML = `<i class="fas fa-bell"></i> ${msg}`; t.className = "show";
            setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
        }

        // --- HELPER: LINKIFY ---
        function linkify(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, function(url) {
                return `<a href="${url}" target="_blank">${url}</a>`;
            });
        }

        // --- ADMIN ---
        function initAdminPanel() {
            getEl('btn-admin-change-pass').onclick = async () => {
                const newPass = prompt("Enter new password for Admin:");
                if (newPass && newPass.length > 0) {
                    try { await updateDoc(doc(db, "users", "ADMIN"), { password: newPass }); showToast("Admin Password Updated! üîê"); } 
                    catch (e) { showToast("Failed to update password."); }
                }
            };

            if(unsubUsers) unsubUsers();
            unsubUsers = onSnapshot(collection(db, "users"), (snap) => {
                const tbody = getEl('admin-users-table'); tbody.innerHTML = "";
                let elfCount = 0;
                snap.forEach(d => {
                    const userData = d.data();
                    if (userData.username === 'ADMIN') return;
                    elfCount++;
                    tbody.innerHTML += `
                        <tr>
                            <td style="padding:10px; border-bottom:1px solid #eee; font-weight:bold;">${d.id}</td>
                            <td style="padding:10px; border-bottom:1px solid #eee; text-align:center; font-family:monospace; color:#D62828;">${userData.password}</td>
                            <td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">
                                <button class="btn btn-sm" onclick="window.changePass('${d.id}')"><i class="fas fa-key"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="window.deleteUser('${d.id}')"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>`;
                });
                getEl('elves-count').innerText = elfCount;
            });

            if(unsubPairings) unsubPairings();
            unsubPairings = onSnapshot(doc(db, "game", "pairings"), (snap) => {
                const tbody = getEl('admin-pairings-table'); tbody.innerHTML = "";
                if(snap.exists()) {
                    snap.data().list.forEach(p => { tbody.innerHTML += `<tr><td style="padding:10px;">${p.mom}</td><td class="text-center"><i class="fas fa-arrow-right" style="color:#ccc;"></i></td><td style="padding:10px;">${p.child}</td></tr>`; });
                }
            });

            getEl('btn-toggle-reg').onclick = async () => { await updateDoc(doc(db, "config", "settings"), { registrationOpen: !gameConfig.registrationOpen }); };
            getEl('btn-reveal-all').onclick = async () => {
                if(confirm("‚ö† WARNING: Reveal everyone's secret?")) { await updateDoc(doc(db, "config", "settings"), { revealed: true }); fireConfetti(); showToast("Identities Revealed! üéÅ"); }
            };
            getEl('btn-reset-game').onclick = async () => {
                if(prompt("Type 'DELETE' to permanently wipe ALL data.") === 'DELETE') {
                    showToast("Deleting...");
                    const userSnap = await getDocs(collection(db, "users"));
                    const batch = writeBatch(db);
                    userSnap.forEach((doc) => { if (doc.id !== 'ADMIN') batch.delete(doc.ref); });
                    const taskSnap = await getDocs(collection(db, "tasks"));
                    taskSnap.forEach((doc) => batch.delete(doc.ref));
                    await batch.commit();
                    await setDoc(doc(db, "game", "pairings"), { list: [] });
                    await updateDoc(doc(db, "config", "settings"), { revealed: false, registrationOpen: true });
                    showToast("Reset Successful.");
                }
            };
            initSpinWheel();
        }

        window.changePass = async (username) => {
            const newPass = prompt(`Enter new password for ${username}:`);
            if(newPass && newPass.length > 0) {
                try { await updateDoc(doc(db, "users", username), { password: newPass }); showToast(`Password updated for ${username}`); } 
                catch (e) { showToast("Error updating"); }
            }
        };

        window.deleteUser = async (username) => {
            if(confirm(`Delete user "${username}"?`)) {
                try { await deleteDoc(doc(db, "users", username)); showToast(`Elf ${username} has been exiled! ü•æ`); } 
                catch(e) { showToast("Error removing user."); }
            }
        };

        // --- SPIN WHEEL LOGIC ---
        async function initSpinWheel() {
            const wheelCanvas = getEl('wheelCanvas');
            const wrapper = wheelCanvas.parentElement;
            let wCtx;
            let wheelUsers = [];

            const uSnap = await getDocs(collection(db, "users"));
            uSnap.forEach(d => {
                if (d.data().username !== 'ADMIN' && d.data().role !== 'admin') wheelUsers.push(d.id);
            });

            function resizeWheel() {
                const width = wrapper.clientWidth;
                const height = wrapper.clientHeight;
                if (width === 0 || height === 0) return;

                const dpr = window.devicePixelRatio || 1;
                wheelCanvas.width = width * dpr;
                wheelCanvas.height = height * dpr;
                wheelCanvas.style.width = `${width}px`;
                wheelCanvas.style.height = `${height}px`;

                wCtx = wheelCanvas.getContext('2d');
                wCtx.scale(dpr, dpr);

                if (wheelUsers.length > 0) drawWheel(wCtx, wheelUsers, 0, width);
            }

            const observer = new ResizeObserver(() => { resizeWheel(); });
            observer.observe(wrapper);

            getEl('btn-spin').onclick = async () => {
                wheelUsers = [];
                const freshSnap = await getDocs(collection(db, "users"));
                freshSnap.forEach(d => { if (d.data().username !== 'ADMIN' && d.data().role !== 'admin') wheelUsers.push(d.id); });
                
                if(wheelUsers.length < 2) return showToast("Need at least 2 Elves!");

                let startAngle = 0; let spinTime = 0; let spinTimeTotal = 4000; let rotateAngle = 0;
                wheelUsers.sort(() => Math.random() - 0.5);

                const animate = () => {
                    spinTime += 20;
                    if(spinTime >= spinTimeTotal) { stopAnimation(); return; }
                    
                    const spinAngle = (Math.random() * 10 + 10) - ((Math.random() * 10 + 10) * spinTime) / spinTimeTotal;
                    rotateAngle += (spinAngle * Math.PI / 180);
                    drawWheel(wCtx, wheelUsers, rotateAngle, wrapper.clientWidth);
                    requestAnimationFrame(animate);
                };

                const stopAnimation = async () => {
                    let pairings = [];
                    for(let i=0; i<wheelUsers.length; i++) {
                        let mom = wheelUsers[i]; let child = wheelUsers[(i+1) % wheelUsers.length];
                        pairings.push({ mom, child });
                    }

                    showToast("Cleaning up old tasks... üßπ");
                    try {
                        const taskSnap = await getDocs(collection(db, "tasks"));
                        const batch = writeBatch(db);
                        taskSnap.forEach((doc) => { batch.delete(doc.ref); });
                        await batch.commit(); 

                        await setDoc(doc(db, "game", "pairings"), { list: pairings });
                        await updateDoc(doc(db, "config", "settings"), { revealed: false });

                        fireConfetti(); 
                        showToast("Game Reset & Pairs Assigned! ‚ú®"); 
                        getEl('spin-result').innerText = `Freshly Paired ${wheelUsers.length} Elves!`;
                    } catch (e) {
                        console.error("Error cleaning up:", e);
                        showToast("Error resetting game data!");
                    }
                };
                animate();
            };
        }

        function drawWheel(ctx, users, startAngle, size) {
            if(!ctx) return;
            const w = size, h = size; 
            const cx = w/2, cy = h/2;
            const outsideRadius = (w/2) - 5; 
            const textRadius = (w/2) * 0.65; 
            
            ctx.clearRect(0,0,w,h);
            if (users.length === 0) return;
            
            const arc = Math.PI * 2 / users.length; 
            const colors = ["#D62828", "#FFFFFF", "#2D6A4F", "#F4D35E"]; 
            
            users.forEach((user, i) => {
                const angle = startAngle + i * arc;
                ctx.fillStyle = colors[i % colors.length];
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, outsideRadius, angle, angle + arc, false);
                ctx.lineTo(cx, cy);
                ctx.fill();
                ctx.lineWidth = 1; ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.stroke();

                ctx.save();
                ctx.fillStyle = (i % colors.length === 1 || i % colors.length === 3) ? "#1B4332" : "#FFFFFF"; 
                ctx.font = 'bold 14px Nunito';
                ctx.shadowColor = "rgba(0,0,0,0.2)"; ctx.shadowBlur = 2;

                ctx.translate(cx + Math.cos(angle + arc / 2) * textRadius, cy + Math.sin(angle + arc / 2) * textRadius);
                ctx.rotate(angle + arc / 2 + Math.PI / 2);
                
                const displayUser = user.length > 10 ? user.substring(0,10) + ".." : user;
                ctx.fillText(displayUser, -ctx.measureText(displayUser).width / 2, 0);
                ctx.restore();
            });

            ctx.beginPath();
            ctx.arc(cx, cy, 30, 0, 2 * Math.PI, false);
            ctx.fillStyle = "#111"; 
            ctx.fill();
            ctx.lineWidth = 3; ctx.strokeStyle = "#fff"; ctx.stroke();

            ctx.save();
            ctx.fillStyle = "#FFF"; ctx.font = 'bold 16px Nunito';
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText("Spin", cx, cy);
            ctx.restore();
        }

        // --- USER ---
        async function initUserPanel(username) {
            getEl('display-username').innerText = username;
            if(unsubPairings) unsubPairings();
            unsubPairings = onSnapshot(doc(db, "game", "pairings"), (docSnap) => {
                if (docSnap.exists()) {
                    const allPairs = docSnap.data().list || [];
                    const myPairAsMom = allPairs.find(p => p.mom === username);
                    const myPairAsChild = allPairs.find(p => p.child === username);
                    if (myPairAsMom && myPairAsChild) {
                        myChild = myPairAsMom.child; myMom = myPairAsChild.mom;
                        getEl('mom-waiting-msg').classList.add('hidden'); getEl('mom-panel-content').classList.remove('hidden');
                        getEl('child-panel-content').classList.remove('hidden'); getEl('chat-section').classList.remove('hidden');
                        updateUIBasedOnConfig();
                        initTasks(username, myChild);
                        initChats(username, myMom, myChild);
                    } else {
                        getEl('mom-waiting-msg').classList.remove('hidden'); getEl('mom-panel-content').classList.add('hidden');
                        getEl('child-panel-content').classList.add('hidden'); getEl('chat-section').classList.add('hidden');
                    }
                }
            });
        }

        // --- TASKS ---
        function initTasks(me, childName) {
            const btnSend = getEl('btn-send-task');
            if(unsubTasksMom) unsubTasksMom();
            
            unsubTasksMom = onSnapshot(query(collection(db, "tasks"), where("fromMom", "==", me)), (snap) => {
                const list = getEl('mom-review-list'); list.innerHTML = "";
                let countToday = 0, total = 0; const todayStr = new Date().toDateString();
                
                snap.docChanges().forEach(change => {
                    if (change.type === 'modified') {
                        const d = change.doc.data();
                        if (d.status === 'completed' && d.timestamp?.seconds * 1000 > loginTime) {
                            playNotification();
                            sendSystemNotification("Task Update", "Your Child Completed a Task! üîî");
                            showToast("Your Child Completed a Task! üîî");
                        }
                    }
                });

                snap.forEach(d => {
                    const t = d.data(); total++;
                    if(t.timestamp && new Date(t.timestamp.seconds*1000).toDateString() === todayStr) countToday++;
                    
                    let actionHtml = '';
                    if (t.status === 'completed') { 
                        actionHtml = `<button class="btn btn-secondary task-action-btn" onclick="window.approveTask('${d.id}')">Approve</button>`; 
                    } else if (t.status === 'pending') {
                        // Added Edit button for pending tasks
                        actionHtml = `<button class="btn btn-sm task-action-btn" onclick="window.editTask('${d.id}', '${t.text.replace(/'/g, "\\'")}')"><i class="fas fa-pencil-alt"></i></button>`;
                    }

                    list.innerHTML += `
                        <div class="task-item">
                            <div class="task-content">
                                <div class="task-text">${t.text}</div>
                                <span class="status-badge status-${t.status}"><i class="fas fa-circle" style="font-size:6px;"></i> ${t.status}</span>
                            </div>
                            <div class="task-actions">${actionHtml}</div>
                        </div>`;
                });

                if (countToday >= 1 || total >= 5) { btnSend.disabled = true; btnSend.style.background = "#ccc"; btnSend.style.boxShadow = "none"; btnSend.innerText = total >= 5 ? "All 5 Tasks Sent!" : "Daily Limit (1/1) Reached"; } 
                else { btnSend.disabled = false; btnSend.style.background = ""; btnSend.innerText = "Send Challenge"; }
            });

            btnSend.onclick = async () => {
                const text = getEl('task-input').value.trim();
                if(!text) return;
                await addDoc(collection(db, "tasks"), { fromMom: me, toChild: childName, text: text, status: 'pending', timestamp: serverTimestamp() });
                getEl('task-input').value = ""; showToast("Challenge Sent! üì®");
            };

            if(unsubTasksChild) unsubTasksChild();
            unsubTasksChild = onSnapshot(query(collection(db, "tasks"), where("toChild", "==", me)), (snap) => {
                const history = getEl('child-task-history'); const currentText = getEl('current-task-text');
                const taskAction = getEl('task-action-area'); const statusMsg = getEl('task-status-msg'); const btnComplete = getEl('btn-complete-task');

                snap.docChanges().forEach(change => {
                    const d = change.doc.data();
                    if (d.timestamp?.seconds * 1000 > loginTime) {
                        if (change.type === 'added') { 
                            playNotification(); 
                            sendSystemNotification("New Task", "You have a new Christmas Challenge! üîî");
                            showToast("New Christmas Challenge! üîî"); 
                        }
                        else if (change.type === 'modified' && d.status === 'approved') { 
                            playNotification(); 
                            sendSystemNotification("Task Approved", "Your task has been approved! üåü");
                            showToast("Task Approved! üåü"); fireConfetti(); 
                        }
                    }
                });

                history.innerHTML = "";
                const tasks = [];
                snap.forEach(d => tasks.push({id: d.id, ...d.data()}));
                tasks.sort((a,b) => b.timestamp - a.timestamp);

                if (tasks.length > 0) {
                    const activeTask = tasks[0]; 
                    currentText.innerText = activeTask.text;
                    if (activeTask.status === 'pending') {
                        taskAction.classList.remove('hidden'); statusMsg.innerText = "Waiting for you to complete...";
                        btnComplete.onclick = async () => { await updateDoc(doc(db, "tasks", activeTask.id), { status: 'completed' }); fireConfetti(); };
                    } else if (activeTask.status === 'completed') {
                        taskAction.classList.add('hidden'); statusMsg.innerText = "Marked done! Waiting for Mom's approval.";
                    } else {
                        taskAction.classList.add('hidden'); statusMsg.innerText = "Approved! Great job, Elf! üåü";
                    }
                    tasks.forEach(t => { history.innerHTML += `<li>${t.text} <span class="status-badge status-${t.status}" style="font-size:0.6rem; margin-left:5px;">${t.status}</span></li>`; });
                } else {
                    currentText.innerText = "No challenges yet. Relax by the fire! ‚òï"; taskAction.classList.add('hidden');
                }
            });
        }

        window.approveTask = async (id) => { await updateDoc(doc(db, "tasks", id), { status: 'approved' }); fireConfetti(); showToast("Task Approved! ‚úÖ"); };
        
        window.editTask = async (id, oldText) => {
            const newText = prompt("Edit your task:", oldText);
            if(newText && newText !== oldText) {
                try { await updateDoc(doc(db, "tasks", id), { text: newText }); showToast("Task Updated! üìù"); }
                catch(e) { showToast("Error updating task."); }
            }
        };

        // --- CHATS ---
        function initChats(me, momName, childName) {
            setupChatWindow(`${me}_${childName}`, 'chat-box-child', 'msg-input-child', 'btn-send-child', me, 'child');
            setupChatWindow(`${momName}_${me}`, 'chat-box-mom', 'msg-input-mom', 'btn-send-mom', me, 'mom');
        }

        // Global functions for message deletion and editing
        window.deleteMessage = async (docId, msgId) => {
            if(confirm("Delete this message?")) {
                try {
                    await deleteDoc(doc(db, "chats", docId, "messages", msgId));
                    showToast("Message Poofed! üí®");
                } catch(e) {
                    console.error(e);
                    showToast("Error deleting message.");
                }
            }
        };

        window.editMessage = async (docId, msgId, oldText) => {
            const newText = prompt("Edit your message:", oldText);
            if(newText && newText !== oldText) {
                try {
                    await updateDoc(doc(db, "chats", docId, "messages", msgId), { text: newText });
                    showToast("Message Updated! ‚ú®");
                } catch(e) {
                    console.error(e);
                    showToast("Error editing message.");
                }
            }
        };

        function setupChatWindow(docId, boxId, inputId, btnId, sender, type) {
            const box = getEl(boxId);
            const sub = onSnapshot(collection(db, "chats", docId, "messages"), (snap) => {
                snap.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const d = change.doc.data();
                        if (d.sender !== sender && d.timestamp?.seconds * 1000 > loginTime) {
                            playNotification();
                            sendSystemNotification("New Message", "You have a new secret message! üéÖ");
                        }
                    }
                });

                box.innerHTML = "";
                const msgs = [];
                snap.forEach(d => msgs.push({ id: d.id, ...d.data() }));
                msgs.sort((a,b) => a.timestamp - b.timestamp);
                
                msgs.forEach(m => {
                    const div = document.createElement('div');
                    div.className = `message ${m.sender === sender ? 'msg-sent' : 'msg-received'}`;
                    
                    // Add delete AND edit button only for sender
                    let actionBtns = '';
                    if(m.sender === sender) {
                        // Escape single quotes for the prompt
                        const safeText = m.text.replace(/'/g, "\\'");
                        actionBtns = `
                            <span class="msg-actions">
                                <span class="msg-btn" onclick="window.editMessage('${docId}', '${m.id}', '${safeText}')"><i class="fas fa-pencil-alt"></i></span>
                                <span class="msg-btn" onclick="window.deleteMessage('${docId}', '${m.id}')"><i class="fas fa-trash"></i></span>
                            </span>`;
                    }

                    // Process links
                    const processedText = linkify(m.text);

                    div.innerHTML = `${processedText} ${actionBtns}<div class="msg-meta">${m.timestamp ? new Date(m.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...'}</div>`;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
            
            if(type === 'child') unsubChatChild = sub;
            else unsubChatMom = sub;

            getEl(btnId).onclick = async () => {
                const txt = getEl(inputId).value.trim();
                if (!txt) return;
                getEl(inputId).value = ""; 
                await addDoc(collection(db, "chats", docId, "messages"), { text: txt, sender: sender, timestamp: serverTimestamp() });
            };
        }
    </script>
</body>
</html>
